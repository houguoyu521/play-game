<!DOCTYPE html>
<html>
<head>
    <title>材料数据预测系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">自定义数据预测平台</h1>
        
        <!-- 文件上传区 -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <input type="file" id="fileInput" class="mb-4"
                   accept=".csv, .CSV, .xls, .xlsx">  <!-- 明确支持的格式 -->
            <button onclick="handleUpload()" 
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                上传数据
            </button>
            <div id="uploadStatus" class="mt-2 text-gray-600"></div>
        </div>

        <!-- 列选择区 -->
        <div id="columnSelection" class="hidden bg-white p-6 rounded-lg shadow mb-6">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2">选择composition列：</label>
                    <select id="compositionSelect" class="border p-2 w-full"></select>
                </div>
                <div>
                    <label class="block mb-2">选择预测目标列（Y值）：</label>
                    <select id="targetSelect" class="border p-2 w-full"></select>
                </div>
            </div>
            <button onclick="startTraining()" 
                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                开始训练
            </button>
        </div>

        <!-- 结果展示 -->
        <div id="resultSection" class="hidden bg-white p-6 rounded-lg shadow">
            <canvas id="resultChart"></canvas>
            <div id="metrics" class="mt-4 text-gray-600"></div>
        </div>
    </div>

    <script>
        let chart = null;
        const SERVER_URL = "http://150.158.48.97";  <!-- 保留原配置，如需动态适配可改为空字符串 -->

        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) return alert("请选择文件");
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${SERVER_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.error) throw new Error(result.error);
                
                // 显示列选择界面
                document.getElementById('columnSelection').classList.remove('hidden');
                populateSelectOptions(result.columns);
                showDataPreview(result.preview);
            } catch (error) {
                alert(`上传失败: ${error.message}`);
            }
        }

        function populateSelectOptions(columns) {
            const options = columns.map(col => `<option value="${col}">${col}</option>`).join('');
            document.getElementById('compositionSelect').innerHTML = options;
            document.getElementById('targetSelect').innerHTML = options;
        }

        function showDataPreview(preview) {
            const previewHtml = Object.entries(preview).map(([col, values]) => `
                <div class="mb-2">
                    <span class="font-semibold">${col}:</span>
                    <span class="text-gray-600">${values.join(', ')}...</span>
                </div>
            `).join('');
            document.getElementById('uploadStatus').innerHTML = `
                <div class="mt-4">
                    <p class="font-bold mb-2">数据预览（前5行）：</p>
                    ${previewHtml}
                </div>
            `;
        }

        async function startTraining() {
            const targetCol = document.getElementById('targetSelect').value;
            const compositionCol = document.getElementById('compositionSelect').value;
            
            try {
                const response = await fetch(`${SERVER_URL}/train`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        target_col: targetCol,
                        composition_col: compositionCol
                    })
                });
                const result = await response.json();
                
                if (result.error) throw new Error(result.error);
                
                document.getElementById('resultSection').classList.remove('hidden');
                updateChart(result.y_test, result.y_pred, result.rmse);
                document.getElementById('metrics').innerHTML = `
                    <div class="mt-4">
                        <p class="font-bold">模型评估结果：</p>
                        <p>RMSE: ${result.rmse.toFixed(4)}</p>
                        <p class="mt-2">使用特征：${result.features.join(', ')}</p>
                    </div>
                `;
            } catch (error) {
                alert(`训练失败: ${error.message}`);
            }
        }

        function updateChart(actual, predicted, rmse) {
            const ctx = document.getElementById('resultChart').getContext('2d');
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '实际值 vs 预测值',
                        data: actual.map((a, i) => ({x: a, y: predicted[i]})),
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        pointRadius: 5
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: '实际值' }},
                        y: { title: { display: true, text: '预测值' }}
                    },
                    plugins: {
                        title: { 
                            display: true, 
                            text: `预测结果 - RMSE: ${rmse.toFixed(2)}`
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>